# Source Generation Snapshot Tests

The source generator can produce a large amount of output. Unit testing using
traditional assertions do not scale very well; it would generally require
asserting very large and escaped strings that degrade the readability of the
test code. Consequently, the unit tests for the output produced by the source
generator use _snapshot testing_. The expected output is placed in files under
the test project. When a test case runs, the actual output from the source
generator is also written to files. What is asserted at the end is that the
inventory of files produced and their content compare equal. If there is any
difference then the test is failed.

In addition to the output generated by the source generator, an additional file
called `diagnostics.json` may be generated if there are diagnostics emitted. It
will contain an JSON array of diagnostic objects. The diagnostics may be
considered as expected output if the test case is intentionally testing for
erroneous operation.

The source generator test cases that employ the snapshot testing strategy can be
found in the class `SourceGeneratorTests`.

The expected output files can be found in sub-folders under
`tests/DocoptNet.Tests/CodeGeneration/SourceGeneratorTests`. Each sub-folder
will be named after its test case. All C# sources in those folders, while
appearing to be part of the test project, do not contribute to the compilation
of the test project itself. They are therefore just loose files on the file
system.

## [The Workflow]

It is expected that the general workflow for adding a new test case will be as
follows:

1. Add the test case without any expected output files.

2. Run the test case and let it fail.

3. Validate that the actual output files are correct.

4. Move the actual output files to where the expected output files should be
   found. In effect, this is like taking a _snapshot_ of the output.

5. Run the test case again to ensure it passes.

Once the snapshot is in place, the test will fail if an update or refactoring of
the source generator code will produce a different output.

Sometimes, an update to the source generator code will produce an intentional
change in the output. When the test fails, inspect the difference between the
expected and actual output, and update the expected snapshot with the actual
output if the changes in the latter are correct.

## Snapshot Helper Script

To assist with [the workflow], the C# script `sgss.csx` can be used to inspect
and accept the actual output as the expected snapshot. The script requires
[dotnet-script] and Git to be installed, and expects to operate within a clone
of the project's Git repository.

[dotnet-script] can be installed by running
`dotnet tool restore` with the project root as the current working directory.

When a test case fails, run the script as follows:

    dotnet script tests/DocoptNet.Tests/sgss.csx inspect -i

The script will create a temporary working tree from the current branch, where
the expected output will be replaced by the actual output, and then proceed to
launch the Git GUI (`git gui`) so that the changes can be interactively (`-i`)
inspected. When the Git GUI is closed, the temporary working tree is removed.

Without `-i`, the Git GUI is launched but the temporary working tree is not
removed. This allows the usual `git` commands, such as `git diff`, to be used to
explore the changes.

To remove the temporary working tree and branch, run:

    dotnet script tests/DocoptNet.Tests/sgss.csx clean --force

If the actual output is intended then running the `accept` command of the script
will replace the expected output snapshot with the actual output, thus becoming the new expected output:

    dotnet script tests/DocoptNet.Tests/sgss.csx accept

For more detailed usage of the script, run:

    dotnet script tests/DocoptNet.Tests/sgss.csx -- -h    

[the workflow]: #workflow
[dotnet-script]: https://www.nuget.org/packages/dotnet-script
